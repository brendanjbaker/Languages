#!/usr/bin/env bash

set -Eeuo pipefail

declare -a commits=(
	'0a2f275d9e1d2fa38d47f42965158d011083f1a4'
	'6cebb815cb3bba8adbd82ec6647dfb6156515791'
	'2967e3d96f7f61c75b9a5ff6d97e1c319bd6afb2'
	'a7313d5d2e6324133eb03b6e4bb66bad0c23bc75'
	'5999813de64f4dbfa98f27b07834f9ddf6e7aac5'
	'85a7357534f16c756b5a5d7895e491a08907e1d2'
	'f7af91e7393c24d7ba72149c2d8219b9e20ac4ba'
	'59854250308a7ad3e3aa9d5e599cef6b53659cc1'
	'a025074124e10df3148d1114dbc28c0adb16cec6'
	'570bc6f49d7d45bdb3bf90ddf9d29add23429dce'
	'a51093d7b1b593237efa51ee1139093bee6bb416'
	'7b32a060b9cfb3ed612a33cfbef780a214997906'
	'6a171200d5db970798b705e39c2d87c251160c6a'
	'ad487523f29504153417ff7db6f53bcfeaaa196f'
	'd8fed8c8f8fb5de9dfbccbf2eab5a99d9fc99593'
	'75df08289dee9b7910c483b80a6c4bdce04919ec'
	'edee00be61371fe881a98e7218c849dbd4494143'
	'687cdba9cb4c11979e592a244fb30d090eac9429'
	'3ac0fa3e21be0ea640c581226ca98048a4e8ee05'
	'a82ed4feca00da2eb2c51198363bf5f75b3d619a'
	'2eb20a44b76a498be9d88130439a2816c7248c89'
	'3596036970c3518f8686d35bafa0db76a3a5d3ec'
	'e68cea004c9968e040e50d0449abbb98c8e68a3f'
	'b53fe1d9d1d4be0aa2ec2271ef5abb2ae26a43a3'
	'eccda1d42bdafc51a9d59dfe1029f03cdcd9c4b0'
	'b3882206572779a70ac2258f109ea50ee1cf3353'
	'b6b8b19cfe46aaea5f69ec8bf496e472a323543c'
	'03bc52aa2236bbbfc41352da040b7c384dacd860'
	'b856b0b44d9d6e651dd0b472708adfd762bd46f5'
	'8cd023b8748f60499a775bcc664d1e30bfa79158'
	'd5b2ea0653beebc0eaa7ea354031f7021b26036d'
	'e3a7e4f45fb6c446d4a285b22bb02afed29ee1e0'
	'8c26dd65f2ddedcf1e0f63b815e87ba8462e1040'
	'23c63264486b87a0edec42e1decb6c24306a5efe'
	'f010932d32f024fd92c7b55fb6ffce3fe1717905'
	'178716c3f74a7efbe43e0421b5aaefc0c45a39a2'
	'59475000f5fccc3d3cd73dfdf5d53dccd9d2e1e5'
	'0d3d671d18a146af3fba6fc8c56d4ce2d6a9009e'
	'9530171113640a74d6378724027e1723500b53c1'
	'38716f6ad11215d618da6f94a526452cf44c3306'
	'3841822e1b457903224650b88877ce8fe83a8f10'
	'36897ac596f64278028a404f405807c04ad85794'
	'c22d45ec8d19b86666891c8412ff8e94466727c1'
	'fb67421d9dd67bb203d446180cf9ff6ae9af2540'
	'a08c96b5053ec79a734910d8246f893a462bf36b'
	'5d71c280435072dead9fb86335f347969e588737'
	'e07e577f41decc1536443ab87f9a635a09accdbc'
	'4a43935a7a9c625d63b159efb8a6287070aa4d75'
	'ad1fb159d5cf4f5cd9a34d850000a9979c0a5625'
	'2c7f45a1a5f62cb5d8562aa216ceaa8d394faea0'
	'e8a989f4ee241f58d6753e3fcdce8f3e737445e7'
	'd75a415da2b57dc59da32377da236a3b1cdec535'
	'f09f52048385cb667b868362c9013a9695dcee80'
	'9b88b6deae321f2fc1a3e5b203c8d049912a58e2'
	'e26f43aeb80034de13f19146a908bdb168e50273'
	'0c25ed5de7aa7b1e8c5853f3b76ba91f89ec6ae7'
	'b948eddf51e13e03497a1509155897bf02e9fc93'
	'e2e448420144ea5eabcaf23736c8c7468c9b64cf'
	'be7f02eba9a12a56b1af4ece8f5978d209f0f081'
	'8e6956e988eb1520568b0df419ec05e0974e5e23'
	'4f0f999fdf53934d1345e5094fefd915e3e75289'
	'3370ec76aa2493f1671585f44a5115eeb2c238f0'
	'3966e816b0f213fbe1dde60d96a2bc72ac3a3f9d'
	'14bf3c17e236f19a3aaad524622937b34e772da0'
	'de6f0fb77649caecfbb7497623736f66cf26eb1a'
	'8f0682a889485bfac4ea46d3767ae187d7a456b3'
	'392c756582c6adacd70013d8f6a6a13c8b50102e'
	'ba3e39e983335b8c03d31b2397f5831148a5f03c'
	'3a159be4928ce3a271a31849201ebc0f31b2bccf'
	'1bae2046a601a33a03546cef370476e727244288'
	'4ee5e332f89d9d710815990e1a81a42b2fb4368e'
	'32129304a712803fd9bfef8d0b2b70514014fd00'
	'a12622beca8a38340585114cbbd3e40631a10dc5'
	'd1ff1b0d3dcdf7caf9dab60b18280f19b362363c'
	'3f70710d1a02bdbf5649a1527b58bc9f029ef7f8'
	'aa6b4e725e6f90125e33f2befc2fecbb5c729af5'
	'94e498c7e221881d13f650a6766b5ee5347fb9a2'
	'3e713fa89d9a00fa7420b69e114e205a48c6564c'
	'aafd30ed8b9c1b14305e7a04bec5d9e7c6ea5eb5'
	'7002a655786e85d40c5f23cbb2f5f1db3e5c204e'
	'ec8ce6ea42f5c01e368e73f9d421302d6d7b3eca'
	'9e4091c95eb5d36945a63da972f99543289b24f3'
	'183f53e85ac26ed6bc0ff77e065262a44f6f127e'
	'a28384d1b8d4ae874646541c1a5ecea54c9783fd'
	'12759a3b5a646c98352231043d4a03654ba3f4dd'
	'4cdded6afacf3fb17bab64358bab8fdbcd789a7a'
	'a942b12723c6407e787d68630321bcffaad6934d'
	'cdeb9966f8b3a4560342deb0f7f1d7896026fd20'
	'381685373ecd2235f26144e5bdee1cd43aa13953'
	'c36c9f053ace41b1d6805dd3948dee776e42983c'
	'1b46989599bb368051b33fff76e40fd995a08d2c'
	'fd5c2d43b9cb0cb2eefd44156f1d48812510f24e'
	'be429f26914275d634958b16209549932056eb3a'
	'492853147992191e9da1bf7f57b02a49b9824ee2'
	'019d16da2aa1599a459335f620b3fef55f855982'
	'7df3bbae656aab0ef28277b376953325e8751731'
	'880434e6b2f98fd93c7c3c07f0873c4bc3864358'
	'7b173f064d751df5046fe03e2e83f17e9e06c0f7'
	'3ae1b21f969310944eeb6eea7a26040d6f3776d2'
	'3208762e4d96ef690613286cb9abf36c02a32f4e'
	'4a2022a2f9c9c59436fd277a71a5a2fd99e32bf8'
	'0fcb04eb10fcfb23d2384247915f254614719b98'
	'c23bfaca16c143cf120092ef9120d6b86ca6f26b'
	'820a833d02894b56db1af187a978a1d89749ab88'
	'20481b8f566e3a64671b99be97f3f015541b54f7'
	'3bb2cb4cddded1a3041fa21745e2523f38a6248d'
	'ed74cffa3ff0921e6a93d868c4dcc26591339246'
	'3c9a698a673f7594b853f0dd40458bd233fa86ee'
	'6d526b9757f6a4d8487884929676c7fb818060d2'
	'c45e264b34067bc0e416d0632a2dafe2be2d5393'
	'c452adfcf95668f24daa319955e66acac20aece1'
	'9f13a88b870588333a29f919284593dac477759e'
	'939390a5e90fbe0043ea9c16fa3f2847f9c57867'
	'eb1a91ebf723bc8671ff88a7612fb58fec53c87c'
	'b92335d89696cf8058480ccf37c01f890f8baafc'
	'6deabc83241aad1cb1768544770ec1b6bc051775'
	'147d3acf887ee264787065a1d823a25f81099254'
	'8ab9310c78cc059dc2e5a8c57d7c6f16711f0ea1'
	'1cfd3744e60f09bdfc67db56b616a359133b64cd'
	'04d2199c4ae776dcf29d8bc49ab3d510fada33c3'
	'41a1fb207724427afcfea0180b32c71cb651f4d9'
	'6f17322018ccf46a7a324b1b6790bdae77f7ae85'
	'9850b4a37642be3a69ce539ea6c9c396ad94a133'
	'bbed879dac2ce9afe8f509d82c46a76f7da04870'
	'6ddec8cb8d441d462916e1cd7d126008ad5dbdbc'
	'390493e12a403c9cfdc5929a3250df5c3ce89502'
	'd93ab37f2bce8b33e187be662ba964458a2140a2'
	'88406420ea7a91d5682569ba51339a5d86ecdf37'
	'82f463379c32ab5745c8897718d1ddf0fb7d41fa'
	'a0312f5cf9c98411a32b46875f201ab738c20d07'
	'cf5c9e30eb78736f6346728343d781820e77390f'
	'f2e5f8a8aaf5af8618cc3baaff64c0de08b27b36'
	'b679c955f47458d7a8dd5214e0ab1ace1d21c7a7'
	'cc49ee08e61fcca0b19265e768a336c135f5e492'
	'9b632e5fcd30052b4ebfee3df6f5a232e90679ee'
	'1cf17e1b0f163ac7b2ea0280918bcb443a15a8ad'
	'68bc95f2688a0da54ec0fb27a2167d17c3481d38'
	'ddd6c2740a4a11a2f1189e9e6cd1d4276157c55f'
	'9518490c28a9e1e494d1357716c9a498080f01d0'
	'7c840f1fd5aede38bc80f7b43ec3a3dd95a2b185'
	'1fd897e19e7f2bf532f192bad3ba9338f7d30b1a'
	'264ef0ae590ef840e0eff52089ae03e5d077c5a0'
	'f8fae3e8222b56ce0891a316bc62069e368548d4'
	'019250587cc8dfe4d1fc7e60b9fc76c3a7776141'
	'8ea2f1cede5d9b5b9acbdabf523576b5ad5fc35c'
	'b49fb948819ccea9e1c8cadcab24dbf7902e5476'
	'61fb3efa11c0b1fe38f946d4094899fddab994a0'
	'2c012023a71b072e41dc257c7cc69b5e9b65784e'
	'b3939632cdd02b7468ac420b613386c4db39fd32'
	'b8e34622c02f5ab1c3211280ac8596bdfe0e01bf'
	'75bc2a558dfdfcc55baa8e2c15b0a312dffc84df'
	'928d30b2bc8c4ecd4ed3e7bae88b5e7ebd014d53'
	'265c5798463a9fc5bfcade582a9d7cfdc076369e'
	'e46c420b62889623a5f2b02b9c74fdd9cca7bd57'
	'91c5618475eff7ad1a2cf281b5742b03f84ac7f7'
	'b7f1db94d891bb827b58145147cd02365e547917'
	'ea6b642de945cb00f22dbef80a167c43bf6bb0cc'
	'24ea107c80e3328b495fbfbbff5d372532ca8682'
	'efd01b5db553c5f1e33c1981194461d6682ab8cb'
	'04c71f4b391b50f17ae611a9317f005847092e11'
	'66d037b1f9135284ba7948dc13f28f83914de114'
	'a5550b03cb93f1f9dc5ccfe3d4f9def40c0d39a0'
	'16900446226e74e8861f5115a84a157978ebf83d'
	'011cc1cff0145cf08fa57a2abc80388a7b529b1e'
	'c10b2d728cb8202be305de0ecffc50280f56933f'
	'7663b33f04d7cec23f6010839c32d7ab4c178566'
	'6bc6b52dd0e0111c7b58e81f50947a131df00aea'
	'ed346bd0af32b675c468e7a57ce08452a37360b3'
	'11a7a82e002ab830733006160b4ab77fc34a1c4c'
	'8823b4c8da778bbe78eb60aca62e7fbd6d747959'
	'ae898377c7f2120512629b7ada6d9ef8bcd7d129'
	'a573cf704cd9d27ecbbdd8dc91b4be1b9a177222'
	'1e4a7d4f6a971c64b96696e41c3dfcda4c9f73b3'
	'3b4a99d25a15f98cf5bf81c457976694b1367d33'
	'd5e99aeece680517f5bc48199ec9a1c3d45e4e76'
	'9a19555e950ede71386ed18ad5c625d6196cbde0'
	'2f5e26cd944bb1b91eb2f24537ffa0a24d810e59'
	'987819df126d3c7e2182410f458c2bdf1ac072db'
	'8eade9a9ac357e2521e3e56b5bf1a602015dbe57'
	'77ef4de5c937c4bfd09db7b4b5f10282f3bcc82a'
	'afc4fb492d2f8eddd8774567d10754665bb48ccc'
	'8d4846e98dfcd3ad7437a8bd40635bdc9995c42e'
	'ba722c643c497834718193a4758e74721679366f'
	'f00e4319d8c7f346efb9993db7cf6b987090145f'
	'9e1ad2261de7eefeb9ca9ca2828b46800159fc54'
	'db142bcf57cf7856c7eff023c5f4fab34bade81a'
	'8e4e97b4eb0eb0f7040f204091193ac008d468e1'
	'07ca31d808b95430cdf6d3accde55a623ff90543'
	'8c0cf6ee4dfb6e9f904ab2f450e35a48920433df'
	'e32ef217b2edc9d6c666145c0dfc9c3857e7a285'
	'ab4dc74bc02ec66931c1cad51a9d43f1f52042c9'
	'a71823c3455786c16519fb6f13738b01211e134b'
	'5ea7a56ecb366b98c3e7217dbf3085d965bb7a33'
	'53b8e8342fb96cef9a05226b37a31f4fe87ac4a0'
	'bd8c598f28c3178a16a19f3fe8cce11613c89592'
	'4f3f0e7f58e4fbb260dcd65317d3b84c97b80cda'
	'94857375f95b71ab099f5b1bed3519bc1cc4b401'
	'149e2a405a7a0cef0eee5e0600f5b5c38a13fd8f'
	'78f9bb87d4fc9cad34739e2fafd48d739ac50224'
	'3dfb952b1cca7898c68db346dec8b2681a88db6b'
	'a89ea856fd918f7f12b6ffa814baeb543cf83808'
	'abe57945abcefeb13f35eefefe412052e952cf1a'
	'dd178aac6832eacbecd5d89f9b5b46587c2be76b'
	'8785eda38e632506185180972ad9fd92479d2475'
	'6ecfa6236ce5e41d3cc978095df3ef18e9d071c9'
	'dedd2d8c75b3ef909310b0deab5d248872b37411'
	'd494fd02cf79094d1b57c11af3d44538a08c0d6d'
	'6a84eb743d87e96971b6fe38f20fb5e5a7315071'
	'd1a8af023fb9fcdb62e2af70bcb303cf029c7578'
	'523ae590c61d2704e2f4b6465214820accc259b9'
	'82c4da18f68300f355a94da527190959a8fc60cb'
	'be094224b9610ac80ebe5781c38551fb2b286dbf'
	'9872a8f457e1031429c139bbf73a3b404f70751a'
	'794e7b6301bccc3a02c6e8ed3de3ae806b434a77'
	'3394856dd9c8a6e7394fbb2931a48bbee06c000f'
	'c6a04c33550341dd1d594c14b11e9e95e33e84a3'
	'9d0485be9bb7f19c5120d77d2d1b6489c25dee00'
	'2f0ad37ac53a900fa032f593346c4f7906e8a3d9'
	'cb17a20f94efff8ace84c22d14459b8488bee380'
	'01a2df3c6419b98ada18553d2198cff258671083'
	'70cabe46741b35d5d2069e1ec32aa4a4fb19954c'
	'3475041219688cc26bfa92bcca4125a28613f224'
	'aec2e72e1583d28dde5bc377e9e9ef6120517b71'
	'525ffdd3a91e2d1c915f6a9ebe4446a102fb3e5b'
	'cc2eda3ee0592a559b83281ba4a2131af6404d83'
	'188db9bae7d550ae017454ae9f7c8aad4e012973'
	'1c7205004124300e85b020f0a348ea4915600835'
	'3a9a97d19c44dcc78068d483216781aef9e72d26'
	'48d8f4f227461ee163c183303f971200745a6331'
	'c1e67bb85323e1aa81f4e4c5844fe4fa8fa34459'
	'cedb718167dcc69a4c23fd9c4f514dbb523106b1'
	'2f7228a70cbc10bb62f21538b8d97930141e6991'
	'3c13d59ba20d7ca50bfe889764e691afcf63e7ef'
	'04ab3eb5f96dedeb15cefcf48445a3a55f73445f'
	'0b1c4531fde0229da67e21e8aa608877424c1002'
	'fa94511a2b5e0c8176b478541c6adb74f1ce457e'
	'16918da577f5a96cac464952cd1955da427e478e'
	'070c0150aa3d9424486b320159b25ade0484c6b4'
	'28fd4edd641403a21e056d0e97f3f083dcf7fb44'
	'30e39fdd1d1818773edf75c95b676e6da3a0d39a'
	'8ef0f68d49648d3314a82a9dd14a7dcd04c2f05d'
	'39c772adc3e605ca98843dcd4bec5acbec5100f5'
	'6e97b128fc3a23444e6e2fbfbe2a75cbf1b2ab95'
	'a11fda5d30513d7e016500abe9162918c8d6a26e'
	'8b01aee40ebdaef5e71dd6e0e6982ef71526840b'
	'14fd60d6901d7be69292a55394f9249fcc37fd5d'
	'9f9390af03c0397944eebe1c1881313f94955248'
	'7f037656c6a3760d5dd0f633108d78dd60fd576f'
	'c989dc3ff1f3cfe10c3cffdcbf5cc06d08ac511d'
	'930bcb5515aaa787d6fddc546c5a6eba1afbe34d'
	'605c35b07c6dd5ab771f889bf9e7e843db5ba875'
	'853b35faa53f4db182898be98ebacc3e881d50cd'
	'158a9c7241627168d398faf1e39163b15aab8afb')

pushd '/opt/cwerg/current'

function apply_patch {
	sed -i '2i#include <algorithm>' 'FE/pp_ast.cc'
}

function build {
	PYPY=python3 CC=gcc CXX=g++ MAKESILENT= make > /dev/null 2>&1
}

function clean {
	git checkout . > /dev/null 2>&1
	git clean -dfx > /dev/null 2>&1
}

export PYTHONPATH='/opt/cwerg/current'

while true; do
	commit=$(git rev-parse HEAD)

	echo "Commit $commit..."
	clean

	if build; then
		echo "Success (NORMAL)! ($commit)"
		break
	else
		clean
		apply_patch

		if build; then
			echo "Success (PATCHED)! ($commit)"
			break
		else
			echo "Failure. ($commit)"
			sleep 10
			clean
			git checkout HEAD^
		fi
	fi
done

# if [[ ! -f program.exe ]]; then
# 	declare cwerg_home='/opt/cwerg/0a2f275'

# 	cwerg \
# 		-stdlib "$cwerg_home/FE/Lib" program.cw \
# 		> 'program.ir'

# 	cat \
# 		"$cwerg_home/BE/StdLib/startup.x64.asm" \
# 		"$cwerg_home/BE/StdLib/syscall.x64.asm" \
# 		"$cwerg_home/BE/StdLib/std_lib.64.asm" \
# 		'program.ir' \
# 		> 'program.ir.combined'

# 	export PYTHONPATH="$cwerg_home"

# 	"$cwerg_home/BE/CodeGenX64/codegen.py" -mode binary - program.exe < 'program.ir.combined'
# fi

# ./program.exe "$@"
